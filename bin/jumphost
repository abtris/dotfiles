#!/usr/bin/env bash
set -e
SUFFIX=`printf "preprod-eus\nprod-ae\nprod-cus\nprod-eus" | fzf`
echo "Logging into Teleport Kubernetes cluster - aks-cp-${SUFFIX}"
tsh kube login "aks-cp-${SUFFIX}"
export PG_HOST=$(kubectl get configmap cluster-vars -n flux-system -o jsonpath='{.data.postgresql_host}')
if [ -z "$PG_HOST" ]; then
    echo "Error: Could not retrieve PostgreSQL host from Kubernetes configmap."
    exit 1
fi
echo "Establishing SSH tunnel to PostgreSQL on jumphost-${SUFFIX}..."
echo "Local port: 63333 -> Remote host: ${PG_HOST}:5432"
tsh ssh -L 63333:${PG_HOST}:5432 "adminuser@jumphost-${SUFFIX}"

