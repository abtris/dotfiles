#!/usr/bin/env bash
set -e
SUFFIX=`printf "integ\npreprod-eus\nprod-ae\nprod-cus\nprod-eus" | fzf`
if [[ "$SUFFIX" == "integ" ]]; then
    echo "Integ selected. Use tshdev to connect dev teleport first."
    tsh ssh -L 5432:db-pgsql-kds-integ-eastus.postgres.database.azure.com:5432 --insecure -N adminuser@jumphost-dev-eus
    exit 0
fi
echo "Logging into Teleport Kubernetes cluster - aks-cp-${SUFFIX}"
tsh kube login "aks-cp-${SUFFIX}"
export PG_HOST=$(kubectl get configmap cluster-vars -n flux-system -o jsonpath='{.data.postgresql_host}')
if [ -z "$PG_HOST" ]; then
    echo "Error: Could not retrieve PostgreSQL host from Kubernetes configmap."
    exit 1
fi
echo "Establishing SSH tunnel to PostgreSQL on jumphost-${SUFFIX}..."
echo "Local port: 63333 -> Remote host: ${PG_HOST}:5432"
tsh ssh -L 63333:${PG_HOST}:5432 "adminuser@jumphost-${SUFFIX}"

